
THREE.RenderableObject=function(){this.id=0;this.object=null;this.z=0;this.renderOrder=0};THREE.RenderableFace=function(){this.id=0;this.v1=new THREE.RenderableVertex();this.v2=new THREE.RenderableVertex();this.v3=new THREE.RenderableVertex();this.normalModel=new THREE.Vector3();this.vertexNormalsModel=[new THREE.Vector3(),new THREE.Vector3(),new THREE.Vector3()];this.vertexNormalsLength=0;this.color=new THREE.Color();this.material=null;this.uvs=[new THREE.Vector2(),new THREE.Vector2(),new THREE.Vector2()];this.z=0;this.renderOrder=0};THREE.RenderableVertex=function(){this.position=new THREE.Vector3();this.positionWorld=new THREE.Vector3();this.positionScreen=new THREE.Vector4();this.visible=true};THREE.RenderableVertex.prototype.copy=function(a){this.positionWorld.copy(a.positionWorld);this.positionScreen.copy(a.positionScreen)};THREE.RenderableLine=function(){this.id=0;this.v1=new THREE.RenderableVertex();this.v2=new THREE.RenderableVertex();this.vertexColors=[new THREE.Color(),new THREE.Color()];this.material=null;this.z=0;this.renderOrder=0};THREE.RenderableSprite=function(){this.id=0;this.object=null;this.x=0;this.y=0;this.z=0;this.rotation=0;this.scale=new THREE.Vector2();this.material=null;this.renderOrder=0};THREE.Projector=function(){var Q,C,J=[],n=0,v,c,f=[],b=0,l,A,F=[],x=0,i,M,O=[],t=0,y,q,e=[],P=0,H={objects:[],lights:[],elements:[]},I=new THREE.Vector3(),G=new THREE.Vector4(),r=new THREE.Box3(new THREE.Vector3(-1,-1,-1),new THREE.Vector3(1,1,1)),R=new THREE.Box3(),L=new Array(3),K=new Array(4),a=new THREE.Matrix4(),g=new THREE.Matrix4(),z,B=new THREE.Matrix4(),o=new THREE.Matrix3(),N=new THREE.Frustum(),s=new THREE.Vector4(),h=new THREE.Vector4();this.projectVector=function(S,T){console.warn("THREE.Projector: .projectVector() is now vector.project().");S.project(T)};this.unprojectVector=function(S,T){console.warn("THREE.Projector: .unprojectVector() is now vector.unproject().");S.unproject(T)};this.pickingRay=function(S,T){console.error("THREE.Projector: .pickingRay() is now raycaster.setFromCamera().")};var d=function(){var ae=[];var aa=[];var Z=null;var ac=null;var Y=new THREE.Matrix3();var W=function(ag){Z=ag;ac=Z.material;Y.getNormalMatrix(Z.matrixWorld);ae.length=0;aa.length=0};var ab=function(ai){var ag=ai.position;var aj=ai.positionWorld;var ah=ai.positionScreen;aj.copy(ag).applyMatrix4(z);ah.copy(aj).applyMatrix4(g);var ak=1/ah.w;ah.x*=ak;ah.y*=ak;ah.z*=ak;ai.visible=ah.x>=-1&&ah.x<=1&&ah.y>=-1&&ah.y<=1&&ah.z>=-1&&ah.z<=1};var T=function(ag,ai,ah){v=u();v.position.set(ag,ai,ah);ab(v)};var V=function(ag,ai,ah){ae.push(ag,ai,ah)};var U=function(ag,ah){aa.push(ag,ah)};var X=function(ai,ah,ag){if(ai.visible===true||ah.visible===true||ag.visible===true){return true}L[0]=ai.positionScreen;L[1]=ah.positionScreen;L[2]=ag.positionScreen;return r.isIntersectionBox(R.setFromPoints(L))};var ad=function(ai,ah,ag){return((ag.positionScreen.x-ai.positionScreen.x)*(ah.positionScreen.y-ai.positionScreen.y)-(ag.positionScreen.y-ai.positionScreen.y)*(ah.positionScreen.x-ai.positionScreen.x))<0};var af=function(ah,ag){var aj=f[ah];var ai=f[ag];i=E();i.id=Z.id;i.v1.copy(aj);i.v2.copy(ai);i.z=(aj.positionScreen.z+ai.positionScreen.z)/2;i.renderOrder=Z.renderOrder;i.material=Z.material;H.elements.push(i)};var S=function(an,al,aj){var ao=f[an];var am=f[al];var ak=f[aj];if(X(ao,am,ak)===false){return}if(ac.side===THREE.DoubleSide||ad(ao,am,ak)===true){l=k();l.id=Z.id;l.v1.copy(ao);l.v2.copy(am);l.v3.copy(ak);l.z=(ao.positionScreen.z+am.positionScreen.z+ak.positionScreen.z)/3;l.renderOrder=Z.renderOrder;l.normalModel.fromArray(ae,an*3);l.normalModel.applyMatrix3(Y).normalize();for(var ah=0;ah<3;ah++){var ai=l.vertexNormalsModel[ah];ai.fromArray(ae,arguments[ah]*3);ai.applyMatrix3(Y).normalize();var ag=l.uvs[ah];ag.fromArray(aa,arguments[ah]*2)}l.vertexNormalsLength=3;l.material=Z.material;H.elements.push(l)}};return{setObject:W,projectVertex:ab,checkTriangleVisibility:X,checkBackfaceCulling:ad,pushVertex:T,pushNormal:V,pushUv:U,pushLine:af,pushTriangle:S}};var D=new d();this.projectScene=function(ap,ah,ar,W){A=0;M=0;q=0;H.elements.length=0;if(ap.autoUpdate===true){ap.updateMatrixWorld()}if(ah.parent===null){ah.updateMatrixWorld()}a.copy(ah.matrixWorldInverse.getInverse(ah.matrixWorld));g.multiplyMatrices(ah.projectionMatrix,a);N.setFromMatrix(g);C=0;H.objects.length=0;H.lights.length=0;ap.traverseVisible(function(aQ){if(aQ instanceof THREE.Light){H.lights.push(aQ)}else{if(aQ instanceof THREE.Mesh||aQ instanceof THREE.Line||aQ instanceof THREE.Sprite){var aR=aQ.material;if(aR.visible===false){return}if(aQ.frustumCulled===false||N.intersectsObject(aQ)===true){Q=m();Q.id=aQ.id;Q.object=aQ;I.setFromMatrixPosition(aQ.matrixWorld);I.applyProjection(g);Q.z=I.z;Q.renderOrder=aQ.renderOrder;H.objects.push(Q)}}}});if(ar===true){H.objects.sort(p)}for(var aD=0,au=H.objects.length;aD<au;aD++){var az=H.objects[aD].object;var ad=az.geometry;D.setObject(az);z=az.matrixWorld;c=0;if(az instanceof THREE.Mesh){if(ad instanceof THREE.BufferGeometry){var ay=ad.attributes;var Z=ad.groups;if(ay.position===undefined){continue}var ab=ay.position.array;for(var aI=0,aG=ab.length;aI<aG;aI+=3){D.pushVertex(ab[aI],ab[aI+1],ab[aI+2])}if(ay.normal!==undefined){var al=ay.normal.array;for(var aI=0,aG=al.length;aI<aG;aI+=3){D.pushNormal(al[aI],al[aI+1],al[aI+2])}}if(ay.uv!==undefined){var ax=ay.uv.array;for(var aI=0,aG=ax.length;aI<aG;aI+=2){D.pushUv(ax[aI],ax[aI+1])}}if(ad.index!==null){var V=ad.index.array;if(Z.length>0){for(var aD=0;aD<Z.length;aD++){var ak=Z[aD];for(var aI=ak.start,aG=ak.start+ak.count;aI<aG;aI+=3){D.pushTriangle(V[aI],V[aI+1],V[aI+2])}}}else{for(var aI=0,aG=V.length;aI<aG;aI+=3){D.pushTriangle(V[aI],V[aI+1],V[aI+2])}}}else{for(var aI=0,aG=ab.length/3;aI<aG;aI+=3){D.pushTriangle(aI,aI+1,aI+2)}}}else{if(ad instanceof THREE.Geometry){var U=ad.vertices;var ac=ad.faces;var aw=ad.faceVertexUvs[0];o.getNormalMatrix(z);var aH=az.material;var Y=aH instanceof THREE.MeshFaceMaterial;var am=Y===true?az.material:null;for(var aA=0,ag=U.length;aA<ag;aA++){var aj=U[aA];I.copy(aj);if(aH.morphTargets===true){var ae=ad.morphTargets;var aF=az.morphTargetInfluences;for(var aC=0,T=ae.length;aC<T;aC++){var av=aF[aC];if(av===0){continue}var S=ae[aC];var ao=S.vertices[aA];I.x+=(ao.x-aj.x)*av;I.y+=(ao.y-aj.y)*av;I.z+=(ao.z-aj.z)*av}}D.pushVertex(I.x,I.y,I.z)}for(var aJ=0,aq=ac.length;aJ<aq;aJ++){var aa=ac[aJ];aH=Y===true?am.materials[aa.materialIndex]:az.material;if(aH===undefined){continue}var af=aH.side;var aP=f[aa.a];var aN=f[aa.b];var aL=f[aa.c];if(D.checkTriangleVisibility(aP,aN,aL)===false){continue}var an=D.checkBackfaceCulling(aP,aN,aL);if(af!==THREE.DoubleSide){if(af===THREE.FrontSide&&an===false){continue}if(af===THREE.BackSide&&an===true){continue}}l=k();l.id=az.id;l.v1.copy(aP);l.v2.copy(aN);l.v3.copy(aL);l.normalModel.copy(aa.normal);if(an===false&&(af===THREE.BackSide||af===THREE.DoubleSide)){l.normalModel.negate()}l.normalModel.applyMatrix3(o).normalize();var X=aa.vertexNormals;for(var aE=0,aM=Math.min(X.length,3);aE<aM;aE++){var aO=l.vertexNormalsModel[aE];aO.copy(X[aE]);if(an===false&&(af===THREE.BackSide||af===THREE.DoubleSide)){aO.negate()}aO.applyMatrix3(o).normalize()}l.vertexNormalsLength=X.length;var ai=aw[aJ];if(ai!==undefined){for(var aB=0;aB<3;aB++){l.uvs[aB].copy(ai[aB])}}l.color=aa.color;l.material=aH;l.z=(aP.positionScreen.z+aN.positionScreen.z+aL.positionScreen.z)/3;l.renderOrder=az.renderOrder;H.elements.push(l)}}}}else{if(az instanceof THREE.Line){if(ad instanceof THREE.BufferGeometry){var ay=ad.attributes;if(ay.position!==undefined){var ab=ay.position.array;for(var aI=0,aG=ab.length;aI<aG;aI+=3){D.pushVertex(ab[aI],ab[aI+1],ab[aI+2])}if(ad.index!==null){var V=ad.index.array;for(var aI=0,aG=V.length;aI<aG;aI+=2){D.pushLine(V[aI],V[aI+1])}}else{var at=az instanceof THREE.LineSegments?2:1;for(var aI=0,aG=(ab.length/3)-1;aI<aG;aI+=at){D.pushLine(aI,aI+1)}}}}else{if(ad instanceof THREE.Geometry){B.multiplyMatrices(g,z);var U=az.geometry.vertices;if(U.length===0){continue}aP=u();aP.positionScreen.copy(U[0]).applyMatrix4(B);var at=az instanceof THREE.LineSegments?2:1;for(var aA=1,ag=U.length;aA<ag;aA++){aP=u();aP.positionScreen.copy(U[aA]).applyMatrix4(B);if((aA+1)%at>0){continue}aN=f[c-2];s.copy(aP.positionScreen);h.copy(aN.positionScreen);if(w(s,h)===true){s.multiplyScalar(1/s.w);h.multiplyScalar(1/h.w);i=E();i.id=az.id;i.v1.positionScreen.copy(s);i.v2.positionScreen.copy(h);i.z=Math.max(s.z,h.z);i.renderOrder=az.renderOrder;i.material=az.material;if(az.material.vertexColors===THREE.VertexColors){i.vertexColors[0].copy(az.geometry.colors[aA]);i.vertexColors[1].copy(az.geometry.colors[aA-1])}H.elements.push(i)}}}}}else{if(az instanceof THREE.Sprite){G.set(z.elements[12],z.elements[13],z.elements[14],1);G.applyMatrix4(g);var aK=1/G.w;G.z*=aK;if(G.z>=-1&&G.z<=1){y=j();y.id=az.id;y.x=G.x*aK;y.y=G.y*aK;y.z=G.z;y.renderOrder=az.renderOrder;y.object=az;y.rotation=az.rotation;y.scale.x=az.scale.x*Math.abs(y.x-(G.x+ah.projectionMatrix.elements[0])/(G.w+ah.projectionMatrix.elements[12]));y.scale.y=az.scale.y*Math.abs(y.y-(G.y+ah.projectionMatrix.elements[5])/(G.w+ah.projectionMatrix.elements[13]));y.material=az.material;H.elements.push(y)}}}}}if(W===true){H.elements.sort(p)}return H};function m(){if(C===n){var S=new THREE.RenderableObject();J.push(S);n++;C++;return S}return J[C++]}function u(){if(c===b){var S=new THREE.RenderableVertex();f.push(S);b++;c++;return S}return f[c++]}function k(){if(A===x){var S=new THREE.RenderableFace();F.push(S);x++;A++;return S}return F[A++]}function E(){if(M===t){var S=new THREE.RenderableLine();O.push(S);t++;M++;return S}return O[M++]}function j(){if(q===P){var S=new THREE.RenderableSprite();e.push(S);P++;q++;return S}return e[q++]}function p(T,S){if(T.renderOrder!==S.renderOrder){return T.renderOrder-S.renderOrder}else{if(T.z!==S.z){return S.z-T.z}else{if(T.id!==S.id){return T.id-S.id}else{return 0}}}}function w(W,V){var U=0,Z=1,X=W.z+W.w,T=V.z+V.w,S=-W.z+W.w,Y=-V.z+V.w;if(X>=0&&T>=0&&S>=0&&Y>=0){return true}else{if((X<0&&T<0)||(S<0&&Y<0)){return false}else{if(X<0){U=Math.max(U,X/(X-T))}else{if(T<0){Z=Math.min(Z,X/(X-T))}}if(S<0){U=Math.max(U,S/(S-Y))}else{if(Y<0){Z=Math.min(Z,S/(S-Y))}}if(Z<U){return false}else{W.lerp(V,U);V.lerp(W,1-Z);return true}}}}};